<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Appointments - Hospital Management</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .appointments-container {
      margin-top: 30px;
      text-align: center;
    }

    table {
      width: 80%;
      margin: 20px auto;
      border-collapse: collapse;
      background-color: #222;
      color: #eee;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #444;
    }

    th {
      background-color: #333;
    }

    .add-form {
      margin-top: 20px;
    }

    .add-form input, .add-form select {
      padding: 8px;
      margin: 5px;
      border-radius: 5px;
      border: none;
    }

    .add-form button {
      background-color: #6e44ff;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
    }

    .add-form button:hover {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Title will be dynamically replaced -->
    <h1 id="doctorTitle">Doctorâ€™s Appointments</h1>

    <div class="appointments-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Patient Name</th>
            <th>Date</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="appointmentsTable"></tbody>
      </table>

      <div class="add-form">
        <h3>Add New Appointment</h3>
        <select id="patientSelect"></select>
        <input type="date" id="date" />
        <input type="time" id="time" />
        <button id="addBtn">Add Appointment</button>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const doctor_id = urlParams.get("doctor_id");

    // Fetch doctor name and update title
    async function loadDoctorName() {
    const res = await fetch(`/api/doctors`);
    const doctors = await res.json();
    const doctor = doctors.find(d => d.id == doctor_id);

    if (doctor) {
        document.getElementById("doctorTitle").textContent = `Dr. ${doctor.name}'s Appointments`;
     } else {
            document.getElementById("doctorTitle").textContent = "Doctorâ€™s Appointments";
        }
    }

    async function loadAppointments() {
  const res = await fetch(`/api/appointments?doctor_id=${doctor_id}`);
  const data = await res.json();

  const table = document.getElementById("appointmentsTable");
  table.innerHTML = "";

  if (data.length === 0) {
    table.innerHTML = `<tr><td colspan="4">No appointments yet</td></tr>`;
    return;
  }

  // ðŸ•’ Filter out past appointments
  const now = new Date();
  const upcoming = data.filter(a => {
    const appointmentDateTime = new Date(`${a.date}T${a.time}`);
    return appointmentDateTime >= now;
  });

  if (upcoming.length === 0) {
    table.innerHTML = `<tr><td colspan="4">No upcoming appointments</td></tr>`;
    return;
  }

  // ðŸ©º Display only upcoming appointments
  upcoming.forEach((a) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${a.id}</td>
      <td>${a.patient_name || "Unknown"}</td>
      <td>${a.date}</td>
      <td>${a.time}</td>
    `;
    table.appendChild(row);
  });
}


    async function loadPatients() {
      const res = await fetch("/api/patients");
      const patients = await res.json();
      const select = document.getElementById("patientSelect");
      select.innerHTML = "";
      patients.forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);
      });
    }

    document.getElementById("addBtn").addEventListener("click", async () => {
      const patient_id = document.getElementById("patientSelect").value;
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;

      if (!patient_id || !date || !time) {
        alert("Please fill all fields");
        return;
      }

      const res = await fetch("/api/appointments", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ patient_id, doctor_id, date, time }),
      });

      const data = await res.json();
      alert(data.message);
      loadAppointments();
    });

    loadDoctorName();
    loadPatients();
    loadAppointments();

  </script>
</body>
</html>
